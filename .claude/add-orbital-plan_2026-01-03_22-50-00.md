# Add Orbital Windowing System - Implementation Plan

Created: 2026-01-03 22:50:00 UTC

## Overview

Adding the Orbital windowing system and compositor to the Nix build system for Redox OS.

## Orbital Ecosystem Components

### Core Packages

| Package | Type | Description | Dependencies |
|---------|------|-------------|--------------|
| **orbdata** | Data | Fonts, icons, cursors, backgrounds | None |
| **orbital** | Binary | Display server and window manager | orbdata, libredox, orbclient, orbfont, orbimage |
| **orbterm** | Binary | Terminal emulator for Orbital | orbital |
| **orbutils** | Binary | GUI utilities (calculator, launcher) | orbital |
| **orbutils-orblogin** | Binary | Login manager | orbital |
| **orbutils-launcher** | Binary | Application launcher | orbital |
| **orbutils-background** | Binary | Background setter | orbital |

### Required Graphics Drivers (in base package)

Already built by base package:
- `vesad` - VESA display driver
- `inputd` - Input device daemon
- `fbbootlogd` - Framebuffer boot log display
- `fbcond` - Framebuffer console
- `virtio-gpud` - VirtIO GPU driver
- `bgad` - Bochs Graphics Adapter driver

### Orbital Dependencies (from Cargo.toml)

```toml
libredox = "0.1.3"
orbclient = "0.3.47"
orbfont = "0.1"
orbimage = "0.1"
redox-scheme = "0.6"
redox_syscall = "0.5"
graphics-ipc = { git }
inputd = { git }
serde = "1"
toml = "0.7"
```

## Implementation Steps

### Phase 1: Add Flake Inputs

Add to `flake.nix`:
```nix
orbital-src = {
  url = "gitlab:redox-os/orbital/master?host=gitlab.redox-os.org";
  flake = false;
};

orbdata-src = {
  url = "gitlab:redox-os/orbdata/master?host=gitlab.redox-os.org";
  flake = false;
};

orbterm-src = {
  url = "gitlab:redox-os/orbterm/master?host=gitlab.redox-os.org";
  flake = false;
};

orbutils-src = {
  url = "gitlab:redox-os/orbutils/master?host=gitlab.redox-os.org";
  flake = false;
};
```

### Phase 2: Create Package Files

#### 2.1 orbdata.nix (Data Package - No Compilation)

```nix
# nix/pkgs/userspace/orbdata.nix
{ pkgs, orbdata-src, ... }:

pkgs.stdenv.mkDerivation {
  pname = "orbdata";
  version = "unstable";
  src = orbdata-src;
  dontBuild = true;
  installPhase = ''
    mkdir -p $out
    cp -r . $out/
  '';
}
```

#### 2.2 orbital.nix (Display Server)

Uses mkUserspace.mkPackage with:
- Dependencies: orbdata, orbclient, libredox
- Git sources for graphics-ipc, inputd
- Build flags: `--bin orbital`

#### 2.3 orbterm.nix (Terminal)

Uses mkUserspace.mkPackage with:
- Dependencies: orbital
- Build flags: `--bin orbterm`
- Custom install to copy UI apps directory

### Phase 3: Update Infrastructure

#### 3.1 initfs.nix Changes

Add conditional graphics support:
```nix
{
  # ... existing args
  enableGraphics ? false,
}:

# In buildPhase:
${lib.optionalString enableGraphics ''
  # Copy graphics drivers
  for drv in vesad inputd fbbootlogd fbcond virtio-gpud; do
    cp ${base}/bin/$drv initfs/bin/ 2>/dev/null || true
  done
''}
```

#### 3.2 disk-image.nix Changes

Add optional orbital packages:
```nix
{
  orbital ? null,
  orbterm ? null,
  orbdata ? null,
  enableGraphics ? false,
}:

# In buildPhase:
${lib.optionalString (orbdata != null) ''
  cp -r ${orbdata}/* redoxfs-root/
''}

${lib.optionalString (orbital != null) ''
  cp ${orbital}/bin/orbital redoxfs-root/bin/
  # Create orbital init script
  cat > redoxfs-root/usr/lib/init.d/20_orbital << 'ORBITAL_INIT'
nowait orbital orblogin launcher
ORBITAL_INIT
''}
```

### Phase 4: Configuration Option

Update `config.nix`:
```nix
enableGraphics = mkOption {
  type = types.bool;
  default = false;
  description = "Enable graphics support (Orbital desktop)";
};
```

### Phase 5: Package Export

Update `packages.nix`:
```nix
packages = {
  # ... existing packages
  inherit (modularPkgs.userspace) orbital orbterm orbdata;

  # Graphical disk image variant
  diskImageGraphical = modularPkgs.infrastructure.mkDiskImage {
    inherit kernel bootloader base initfs;
    inherit orbital orbterm orbdata;
    enableGraphics = true;
  };
};
```

## Init System Integration

### Boot Sequence (Graphics Mode)

1. `vesad` - VESA display driver starts
2. `fbbootlogd` - Shows boot log on framebuffer
3. `inputd` - Input device daemon
4. `fbcond` - Framebuffer console (optional)
5. After rootfs mount:
   - `orbital` - Window manager starts
   - `orblogin` - Login prompt
   - `launcher` - Application launcher

### init.d Scripts

```
/usr/lib/init.d/20_orbital:
  nowait orbital orblogin launcher
```

## QEMU/VMM Configuration

### Graphical Mode Requirements

QEMU:
```bash
-display gtk -vga virtio
# or for VGA emulation:
-display gtk -vga std
```

Cloud Hypervisor:
```bash
# VirtIO GPU not fully supported yet
# Use console graphics
```

## Testing Plan

1. Build packages individually:
   ```bash
   nix build .#orbdata
   nix build .#orbital
   nix build .#orbterm
   ```

2. Build graphical disk image:
   ```bash
   nix build .#diskImageGraphical
   ```

3. Test in QEMU graphical mode:
   ```bash
   nix run .#run-redox-graphical
   ```

4. Verify:
   - Display resolution selection appears
   - Orbital starts after login
   - Window management works
   - orbterm launches

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| orbclient SDL dependency | Patch orbclient like sodium does |
| ab_glyph_rasterizer CPU detection | Pin version in Cargo.toml |
| VirtIO GPU in Cloud Hypervisor | Keep QEMU as primary graphical runner |
| Large image size with fonts | Optimize orbdata, use subset fonts |

## Size Impact

| Component | Estimated Size |
|-----------|---------------|
| orbdata (fonts, icons) | ~5-10 MB |
| orbital binary | ~2 MB |
| orbterm binary | ~1 MB |
| Graphics drivers | ~500 KB |

Total addition: ~10-15 MB to disk image (currently 512 MB, sufficient)

## Future Extensions

- orbutils-calculator
- orbutils-file-manager
- Additional themes and icons
- Hardware GPU drivers (Intel, AMD)
