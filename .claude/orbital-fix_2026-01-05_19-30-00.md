# Orbital Desktop Fix - 2026-01-05T19:30:00

## Problem Analysis

Boot log errors from Orbital desktop:
```
[orbital@orbital:50 WARN] inputd -A '1' failed to run with error: No such file or directory (os error 2)
[orbital@orbital::config:114 ERROR] failed to open config '/ui/orbital.toml': No such file or directory (os error 2)
[orbital@orbital::config:99 ERROR] failed to parse config 'TOML parse error at line 1, column 1 ... missing field `cursor`'
[orbital@orbital::core::image:289 ERROR] Image::from_path_scale: Unsupported error (6x)
[orbital@orbital:82 ERROR] error during daemon execution, exiting with status=1: failed to read font: No such file or directory (os error 2)
```

## Root Causes Identified

### 1. Incorrect orbdata copying (FIXED)
The disk-image.nix was looking for directories that don't exist:
```
orbdata/backgrounds/   # Does not exist
orbdata/cursors/       # Does not exist
orbdata/fonts/         # Does not exist (at root)
orbdata/icons/         # Does not exist (at root)
```

Actual orbdata structure:
```
orbdata/ui/orbital.toml      - Config file with cursor/font paths
orbdata/ui/fonts/            - Fonts (Mono/Fira, Sans/Fira subdirs)
orbdata/ui/icons/            - Application icons
orbdata/ui/*.png             - Cursor and window decoration images
orbdata/ui/background.jpg    - Default wallpaper
orbdata/usr/share/applications/mimeapps.list
```

### 2. Missing orblogin binary (FIXED with workaround)
The init script tried to run `orbital orblogin` but orblogin is part of `orbutils` package which is not yet implemented in the Nix build. Changed to use `/bin/login` from userutils instead.

### 3. inputd warning (Non-fatal)
The `inputd -A '1'` warning occurs because Orbital tries to activate a VT by spawning inputd, but inputd is already running from initfs. This is a warning, not an error.

## Fixes Applied

### File: nix/pkgs/infrastructure/disk-image.nix

**Fix 1: Correct orbdata copying**
Changed from copying non-existent subdirectories to copying the actual structure:
```nix
# Copy /ui directory (contains orbital.toml, fonts, icons, cursors, background)
if [ -d "${orbdata}/ui" ]; then
  mkdir -p redoxfs-root/ui
  cp -rv ${orbdata}/ui/* redoxfs-root/ui/
  echo "Copied orbdata/ui/ to /ui/"
fi

# Copy /usr directory (contains share/applications/mimeapps.list)
if [ -d "${orbdata}/usr" ]; then
  mkdir -p redoxfs-root/usr
  cp -rv ${orbdata}/usr/* redoxfs-root/usr/
  echo "Copied orbdata/usr/ to /usr/"
fi
```

**Fix 2: Use /bin/login instead of orblogin**
```nix
# Changed from:
nowait /bin/orbital orblogin
# To:
nowait /bin/orbital /bin/login
```

## Test Results

### Before Fix
- Font error: `failed to read font: No such file or directory`
- Config error: `failed to open config '/ui/orbital.toml'`
- Orbital exits with status=1

### After Fix
- Font error: RESOLVED
- Config error: RESOLVED
- Image loading errors: RESOLVED
- Orbital starts successfully
- New issue: `Operation not supported on transport endpoint (os error 95)` during login

## Remaining Issues

1. **Transport endpoint error**: The login process fails with os error 95. This may be related to PTY handling in Orbital's terminal spawning.

2. **orbutils not packaged**: The orblogin binary from orbutils is not yet available. A proper fix would be to create `nix/pkgs/userspace/orbutils.nix`.

3. **inputd warning**: Non-critical but could be cleaned up by not re-activating VT in Orbital if already done during initfs boot.

## orbdata Structure Reference

The orbdata repository (gitlab.redox-os.org/redox-os/orbdata) provides:
```
ui/orbital.toml          # Orbital config
ui/fonts/Mono/Fira/      # Monospace fonts (Bold.ttf, Regular.ttf)
ui/fonts/Sans/Fira/      # Sans-serif fonts (Bold.ttf, Regular.ttf, SemiBold.ttf)
ui/icons/                # App icons (multiple subdirs)
ui/left_ptr.png          # Default cursor
ui/bottom_left_corner.png
ui/bottom_right_corner.png
ui/bottom_side.png
ui/left_side.png
ui/right_side.png
ui/window_close.png
ui/window_close_unfocused.png
ui/window_max.png
ui/window_max_unfocused.png
ui/background.jpg        # Default wallpaper
ui/login.png             # Login screen background
usr/share/applications/mimeapps.list
```

## Commands for Testing

```bash
# Build graphical disk image
nix build .#diskImageGraphical

# Test in headless mode (serial console)
nix run .#runQemuGraphicalHeadless

# Test in graphical mode (with display window)
nix run .#runQemuGraphical
```
