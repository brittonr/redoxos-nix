# vesad Graphics Daemon Fix

Created: 2026-01-04 04:36:00

## Problem Summary

The graphical mode boot was failing with vesad crashing immediately after starting:

```
vesad: 1280x800 stride 1280 at 0x80000000
thread 'main' (1) panicked at drivers/graphics/vesad/src/main.rs:77:70:
called `Result::unwrap()` on an `Err` value: Os { code: 19, kind: Uncategorized, message: "No such device" }
```

## Root Cause Analysis

### Error Investigation

The error code 19 (ENODEV - "No such device") occurs at line 77 in vesad's main.rs, which is within the event queue subscription setup after calling `DisplayHandle::new_early("vesa")`.

### Architecture Understanding

After extensive research of the RedoxOS drivers codebase:

1. **vesad** - VESA display daemon that writes to a framebuffer provided by UEFI firmware. Creates the `display.vesa` scheme.

2. **inputd** - Input multiplexer daemon that creates the `input:` scheme. Manages virtual terminal (VT) switching and routes keyboard/mouse events.

3. **Interdependency**:
   - vesad calls `DisplayHandle::new_early("vesa")` which attempts to register with inputd
   - inputd with `-A <vt>` flag tries to activate a VT, which requires a display handle from vesad

### Original (Broken) Startup Order

```
vesad           # Crashes - tries to register with inputd but inputd doesn't exist
inputd -A 1     # Would crash - tries to activate VT but vesad didn't create display scheme
ps2d us         # Crashes - needs input: scheme from inputd
fbbootlogd      # Crashes - needs display scheme from vesad
```

### The Circular Dependency

- vesad needs inputd running to register its DisplayHandle
- inputd with `-A` flag needs vesad to activate a VT
- This created a chicken-and-egg problem

## Solution

The fix involves two key changes:

1. **Start inputd FIRST without the -A flag** - This creates the `input:` scheme without trying to activate any VT
2. **Use `nowait` to start inputd in background** - Allows vesad to start while inputd is initializing

### Fixed Startup Order

```
nowait inputd     # Background: creates input: scheme, no VT activation
vesad             # Foreground: creates display.vesa, registers with inputd
ps2d us           # Foreground: registers as input producer
nowait fbbootlogd # Background: uses display scheme
```

## Code Changes

Modified `/nix/pkgs/infrastructure/initfs.nix`:

```nix
# CORRECT ORDER (based on scheme dependencies):
# 1. inputd (no -A) - creates input: scheme, but don't activate VT yet
# 2. vesad - creates display.vesa scheme, registers DisplayHandle with inputd
# 3. ps2d - acts as input producer, needs inputd running
# 4. fbbootlogd - uses display scheme created by vesad

cat >> initfs/etc/init.rc << 'EOF_GRAPHICS'
# Graphics support - start display and input daemons AFTER drivers loaded
echo "Starting input daemon (background, no VT activation)..."
nowait inputd
echo "Starting display daemon..."
vesad
echo "Starting PS/2 input driver..."
ps2d us
echo "Starting framebuffer boot logger..."
nowait fbbootlogd
EOF_GRAPHICS
```

## Test Results

### Graphical Mode Boot
```
Starting input daemon (background, no VT activation)...
Starting display daemon...
vesad: 1280x800 stride 1280 at 0x80000000
Starting PS/2 input driver...
Starting framebuffer boot logger...
...
Redox OS Boot Complete!
```

### Headless Mode Boot
```
Starting random daemon...
...
Redox OS Boot Complete!
```

Both modes now boot successfully to completion.

## Minor Remaining Issue

```
fbbootlogd: failed to open display: Invalid argument (os error 22)
```

This is EINVAL (not ENODEV), suggesting a display scheme format issue in fbbootlogd, not a missing scheme. This is non-fatal and doesn't prevent boot.

## Key Insights

1. **vesad is not a traditional driver** - It writes to a framebuffer given by UEFI firmware, not directly to hardware

2. **Scheme-based IPC** - RedoxOS uses schemes for inter-process communication. Display drivers register with inputd through the input: scheme

3. **`nowait` command** - RedoxOS init supports `nowait` to spawn background processes, essential for breaking the startup dependency chain

4. **The -A flag** - Tells inputd to activate a virtual terminal, which requires the display scheme to already exist

## References

- [RedoxOS Graphics and Windowing](https://doc.redox-os.org/book/graphics-windowing.html)
- [RedoxOS Boot Process](https://doc.redox-os.org/book/boot-process.html)
- [RedoxOS Drivers Repository](https://github.com/redox-os/drivers)
