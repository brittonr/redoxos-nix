# RedoxOS CI Pipeline
#
# Three tiers of checks, ordered by speed:
# 1. Fast (eval/type/lib/artifact) — no cross-compilation, ~30s
# 2. Host builds (cookbook, redoxfs, installer) — native, ~2min
# 3. Cross-compilation (relibc, kernel, base, etc.) — slow, ~20min
#
# The boot test requires KVM and runs separately as a manual dispatch.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ═══════════════════════════════════════════════
  # Tier 1: Fast checks (no cross-compilation)
  # ═══════════════════════════════════════════════
  fast-checks:
    name: "Eval / Type / Artifact / Lib tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: "Formatting check"
        run: nix build .#checks.x86_64-linux.treefmt --no-link

      - name: "Eval tests (all profiles + modules)"
        run: |
          nix build --no-link \
            .#checks.x86_64-linux.eval-profile-default \
            .#checks.x86_64-linux.eval-profile-minimal \
            .#checks.x86_64-linux.eval-profile-cloud \
            .#checks.x86_64-linux.eval-profile-graphical \
            .#checks.x86_64-linux.eval-all-new-modules \
            .#checks.x86_64-linux.eval-version-metadata \
            .#checks.x86_64-linux.eval-assertion-valid-config \
            .#checks.x86_64-linux.eval-system-checks-exist \
            .#checks.x86_64-linux.eval-custom-users \
            .#checks.x86_64-linux.eval-network-static \
            .#checks.x86_64-linux.eval-network-disabled \
            .#checks.x86_64-linux.eval-hardware-custom \
            .#checks.x86_64-linux.eval-environment-empty \
            .#checks.x86_64-linux.eval-extend-works \
            .#checks.x86_64-linux.eval-multi-module-merge \
            .#checks.x86_64-linux.eval-time-config \
            .#checks.x86_64-linux.eval-logging-config \
            .#checks.x86_64-linux.eval-security-config \
            .#checks.x86_64-linux.eval-programs-config \
            .#checks.x86_64-linux.eval-power-config \
            .#checks.x86_64-linux.eval-profile-functional-test

      - name: "Type validation tests"
        run: |
          nix build --no-link \
            .#checks.x86_64-linux.type-valid-user-complete \
            .#checks.x86_64-linux.type-valid-user-minimal \
            .#checks.x86_64-linux.type-valid-network-mode-auto \
            .#checks.x86_64-linux.type-valid-network-mode-dhcp \
            .#checks.x86_64-linux.type-valid-network-mode-none \
            .#checks.x86_64-linux.type-valid-network-mode-static \
            .#checks.x86_64-linux.type-valid-storage-drivers \
            .#checks.x86_64-linux.type-valid-network-drivers \
            .#checks.x86_64-linux.type-valid-graphics-drivers \
            .#checks.x86_64-linux.type-valid-audio-drivers \
            .#checks.x86_64-linux.type-valid-interface \
            .#checks.x86_64-linux.type-valid-programs-config \
            .#checks.x86_64-linux.type-valid-power-config \
            .#checks.x86_64-linux.type-valid-hwclock \
            .#checks.x86_64-linux.type-valid-log-levels \
            .#checks.x86_64-linux.type-valid-namespace-access \
            .#checks.x86_64-linux.type-invalid-network-mode \
            .#checks.x86_64-linux.type-invalid-storage-driver \
            .#checks.x86_64-linux.type-invalid-network-driver \
            .#checks.x86_64-linux.type-invalid-graphics-driver \
            .#checks.x86_64-linux.type-invalid-audio-driver \
            .#checks.x86_64-linux.type-invalid-user-missing-uid \
            .#checks.x86_64-linux.type-invalid-user-missing-gid \
            .#checks.x86_64-linux.type-invalid-user-missing-home \
            .#checks.x86_64-linux.type-invalid-user-missing-shell \
            .#checks.x86_64-linux.type-invalid-interface-missing-address \
            .#checks.x86_64-linux.type-invalid-interface-missing-gateway \
            .#checks.x86_64-linux.type-invalid-bool-type \
            .#checks.x86_64-linux.type-invalid-int-type \
            .#checks.x86_64-linux.type-invalid-list-type \
            .#checks.x86_64-linux.type-invalid-power-action \
            .#checks.x86_64-linux.type-invalid-hwclock \
            .#checks.x86_64-linux.type-invalid-log-level \
            .#checks.x86_64-linux.type-invalid-idle-action \
            .#checks.x86_64-linux.type-invalid-namespace-access \
            .#checks.x86_64-linux.type-invalid-ion-config \
            .#checks.x86_64-linux.type-invalid-helix-config

      - name: "Library function tests"
        run: |
          nix build --no-link \
            .#checks.x86_64-linux.lib-passwd-format-basic \
            .#checks.x86_64-linux.lib-passwd-format-realname \
            .#checks.x86_64-linux.lib-passwd-format-default-realname \
            .#checks.x86_64-linux.lib-passwd-uses-semicolons \
            .#checks.x86_64-linux.lib-passwd-all-fields \
            .#checks.x86_64-linux.lib-passwd-field-order \
            .#checks.x86_64-linux.lib-group-format-basic \
            .#checks.x86_64-linux.lib-group-format-members \
            .#checks.x86_64-linux.lib-group-format-single-member \
            .#checks.x86_64-linux.lib-group-members-comma-separated \
            .#checks.x86_64-linux.lib-group-uses-semicolons \
            .#checks.x86_64-linux.lib-group-all-fields \
            .#checks.x86_64-linux.lib-initrc-run \
            .#checks.x86_64-linux.lib-initrc-notify \
            .#checks.x86_64-linux.lib-initrc-export \
            .#checks.x86_64-linux.lib-initrc-raw \
            .#checks.x86_64-linux.lib-initrc-nowait \
            .#checks.x86_64-linux.lib-initrc-multiple

      - name: "Artifact tests"
        run: |
          nix build --no-link \
            .#checks.x86_64-linux.artifact-rootTree-has-passwd \
            .#checks.x86_64-linux.artifact-rootTree-has-group \
            .#checks.x86_64-linux.artifact-rootTree-has-shadow \
            .#checks.x86_64-linux.artifact-rootTree-has-profile \
            .#checks.x86_64-linux.artifact-rootTree-has-init-scripts \
            .#checks.x86_64-linux.artifact-rootTree-has-startup \
            .#checks.x86_64-linux.artifact-rootTree-has-binaries \
            .#checks.x86_64-linux.artifact-rootTree-has-dns-config \
            .#checks.x86_64-linux.artifact-rootTree-has-shell-aliases \
            .#checks.x86_64-linux.artifact-rootTree-has-home-dirs \
            .#checks.x86_64-linux.artifact-rootTree-has-hostname \
            .#checks.x86_64-linux.artifact-rootTree-has-hostname-in-profile \
            .#checks.x86_64-linux.artifact-rootTree-has-ion-config \
            .#checks.x86_64-linux.artifact-rootTree-has-static-netcfg \
            .#checks.x86_64-linux.artifact-rootTree-has-graphical-init \
            .#checks.x86_64-linux.artifact-rootTree-multi-interface \
            .#checks.x86_64-linux.artifact-rootTree-no-net-when-disabled \
            .#checks.x86_64-linux.artifact-rootTree-no-acpi-when-disabled \
            .#checks.x86_64-linux.artifact-rootTree-no-helix-when-disabled \
            .#checks.x86_64-linux.artifact-rootTree-has-acpi-config \
            .#checks.x86_64-linux.artifact-rootTree-has-logging-config \
            .#checks.x86_64-linux.artifact-rootTree-has-security-policy \
            .#checks.x86_64-linux.artifact-rootTree-has-helix-config \
            .#checks.x86_64-linux.artifact-toplevel-has-structure \
            .#checks.x86_64-linux.artifact-toplevel-has-new-version-fields \
            .#checks.x86_64-linux.artifact-drivers-all-types

      - name: "Assertion tests"
        run: |
          nix build --no-link \
            .#checks.x86_64-linux.eval-assertion-disk-size-invalid \
            .#checks.x86_64-linux.eval-assertion-graphics-no-orbital \
            .#checks.x86_64-linux.eval-assertion-ntp-without-networking \
            .#checks.x86_64-linux.eval-assertion-require-passwords

  # ═══════════════════════════════════════════════
  # Tier 2: Host builds (native, no cross-compilation)
  # ═══════════════════════════════════════════════
  host-builds:
    name: "Host tool builds"
    runs-on: ubuntu-latest
    needs: fast-checks
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: "Build host tools"
        run: |
          nix build --no-link \
            .#checks.x86_64-linux.cookbook-build \
            .#checks.x86_64-linux.redoxfs-build \
            .#checks.x86_64-linux.installer-build

      - name: "DevShell validation"
        run: |
          nix build --no-link \
            .#checks.x86_64-linux.devshell-default \
            .#checks.x86_64-linux.devshell-minimal

  # ═══════════════════════════════════════════════
  # Tier 3: Cross-compilation (slow but comprehensive)
  # ═══════════════════════════════════════════════
  cross-builds:
    name: "Cross-compiled packages"
    runs-on: ubuntu-latest
    needs: host-builds
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: "Build system components"
        run: |
          nix build --no-link \
            .#checks.x86_64-linux.relibc-build \
            .#checks.x86_64-linux.kernel-build \
            .#checks.x86_64-linux.bootloader-build \
            .#checks.x86_64-linux.base-build

      - name: "Build userspace"
        run: |
          nix build --no-link \
            .#checks.x86_64-linux.ion-build \
            .#checks.x86_64-linux.uutils-build \
            .#checks.x86_64-linux.sodium-build \
            .#checks.x86_64-linux.netutils-build

      - name: "Build disk image"
        run: nix build --no-link .#checks.x86_64-linux.redox-default-build
